name: Send message to proper discord channel when a PR is merged.

on:
  push:
    branches:
      - udc
      - vic
      - udc-vanilla
      - vic-vanilla
  pull_request:
    types:
      - closed

jobs:
  process-json-files:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Get changed files in the builds folder
        id: changed-files-specific
        uses: tj-actions/changed-files@v45
        with:
          files: |
            builds/*.json
            changelogs/*.json

      - name: Process JSON files if files changed in builds folder.
        if: steps.changed-files-specific.outputs.any_changed == 'true'
        env:
          VIC_WEBHOOK: ${{ secrets.VIC_WEBHOOK }}
          UDC_WEBHOOK: ${{ secrets.UDC_WEBHOOK }}
          VIC_VANILLA_WEBHOOK: ${{ secrets.VIC_VANILLA_WEBHOOK }}
          UDC_VANILLA_WEBHOOK: ${{ secrets.UDC_VANILLA_WEBHOOK }}
          ALL_CHANGED_FILES: ${{ steps.changed-files-specific.outputs.all_changed_files }}
        run: |
          echo "Processing the following JSON files:"
          
          files=$(echo $ALL_CHANGED_FILES | tr " " "\n")
          missing_txt=()

          for json_file in "${files[@]}"; do
            if [[ "$json_file" == *.json ]]; then
              txt_file="${json_file%.json}.txt"

              if [[ ! " ${files[*]} " =~ ${txt_file} ]]; then
                missing_txt+=("$json_file")
              fi
            fi
          done
      
          echo "JSON files without a matching TXT:"
          printf "%s\n" "${missing_txt[@]}"
          for json in "${missing_txt[@]}"; do
            echo "Processing file: $json"
            python3 .github/push.py $json
          done